<script>
  // ← /d/ と /edit の間のIDを "" で
  const SHEET_ID = "1tDXdwHcKAI_785C1tplQsqUUuiwDvxHVA7uuLyK0iGc";
  const SHEET_NAME = "FAQ";
  // headers=1 を付けるとシート1行目を見出しとして扱う
  const API_URL =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&headers=1&sheet=${encodeURIComponent(SHEET_NAME)}`;

  const $ = s => document.querySelector(s);
  const isPublic = v => (v === true) || (String(v).toUpperCase() === "TRUE");

  async function loadFAQ() {
    try {
      const res = await fetch(API_URL, { cache: "no-store" });
      const text = await res.text();

      if (!text.startsWith("/*O_o*/")) {
        throw new Error("シートの共有が“リンクを知っている全員：閲覧可”になっているか、SHEET_ID/タブ名をご確認ください。");
      }

      const json = JSON.parse(text.substring(47, text.length - 2));

      // 1) 見出しは cols.label を優先
      let header = (json.table.cols || []).map(c => (c && c.label) ? String(c.label).trim() : "");
      // 2) データ行
      let rows = (json.table.rows || []).map(r => r.c.map(c => (c ? c.v : "")));

      // もし label が空（A,B,C…）しか無い場合は、最初の行を見出しとして利用
      const labelsLookInvalid = header.every(h => !h || /^[A-Z]$/.test(h));
      if (labelsLookInvalid && rows.length) {
        header = rows.shift().map(v => String(v).trim());
      }

      // インデックス取得（日本語見出しに完全一致）
      const idx = {
        category: header.indexOf("カテゴリ"),
        question: header.indexOf("質問"),
        answer: header.indexOf("回答"),
        publicFlag: header.indexOf("公開フラグ"),
      };
      if (Object.values(idx).some(v => v === -1)) {
        throw new Error("見出しが一致しません。『カテゴリ / 質問 / 回答 / 公開フラグ』の表記ゆれや空白を確認してください。");
      }

      const data = rows.filter(r => isPublic(r[idx.publicFlag]));
      const container = $("#faq-container");
      container.innerHTML = "";

      if (!data.length) {
        container.innerHTML = `<div style="color:#c62828;background:#ffebee;padding:12px;border-radius:8px;">
          表示対象のFAQが0件です（公開フラグTRUEをご確認ください）。
        </div>`;
        return;
      }

      // カテゴリごとにまとめて描画
      const grouped = {};
      data.forEach(r => {
        const cat = (r[idx.category] || "その他").toString();
        (grouped[cat] ||= []).push(r);
      });

      for (const [cat, items] of Object.entries(grouped)) {
        const wrap = document.createElement("div");
        wrap.className = "category";
        wrap.innerHTML = `<h2>${cat}</h2>`;
        items.forEach(item => {
          const q = document.createElement("div");
          q.className = "question";
          q.textContent = item[idx.question];

          const a = document.createElement("div");
          a.className = "answer";
          a.textContent = item[idx.answer];

          q.addEventListener("click", () => {
            a.style.display = (a.style.display === "block") ? "none" : "block";
          });

          wrap.appendChild(q);
          wrap.appendChild(a);
        });
        container.appendChild(wrap);
      }
    } catch (err) {
      $("#faq-container").innerHTML =
        `<div style="color:#c62828;background:#ffebee;padding:12px;border-radius:8px;">${err.message}</div>`;
      console.error(err);
    }
  }
  loadFAQ();
</script>
